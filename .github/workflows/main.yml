# Este workflow se ejecuta autom√°ticamente en las ramas main y dev
# Se activa con push y pull requests a main y dev
name: Branch Workflow

# Configuraci√≥n de los triggers autom√°ticos
on:
  # Se activa cuando hay un push a las ramas main o dev
  push:
    branches:
      - main
      - dev

# Definici√≥n de los jobs que se ejecutar√°n
jobs:
  # Job para construir y probar la aplicaci√≥n
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # Paso 1: Obtener el c√≥digo del repositorio
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v3

      # Paso 2: Configurar Node.js en el runner
      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # Paso 3: Instalar dependencias
      - name: üì¶ Install dependencies
        run: npm ci

      # Paso 4: Ejecutar el linter
      - name: üßπ Run linting
        run: npm run lint

      # Paso 5: Ejecutar las pruebas
      - name: üß™ Run tests
        run: npm test

      # Paso 6: Construir la aplicaci√≥n
      - name: üèóÔ∏è Build application
        run: npm run build

  # Job para el despliegue
  deploy:
    # Solo se ejecuta si:
    # 1. El job build-and-test se complet√≥ exitosamente
    # 2. Es un push directo a main o dev (no un pull request)
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      # Paso 1: Obtener el c√≥digo del repositorio
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Paso 2: Configurar autenticaci√≥n de Google Cloud
      - name: üîê Set up Google Cloud auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Paso 3: Configurar proyecto de GCP
      - name: üß© Set gcloud project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      # Paso 4: Habilitar servicios requeridos
      - name: ‚öôÔ∏è Enable required services
        run: |
          gcloud services enable run.googleapis.com
          gcloud services enable artifactregistry.googleapis.com
          gcloud services enable secretmanager.googleapis.com

      # Paso 5: Construir y desplegar la aplicaci√≥n
      - name: üöÄ Build and Deploy Backend
        run: |
          SERVICE="backend"
          REGION="us-central1"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          REPO="tower-api"
          IMAGE="us-central1-docker.pkg.dev/$PROJECT_ID/$REPO/$SERVICE"

          # Determinar el ambiente y sufijo de secretos basado en la rama
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            SERVICE_NAME="${SERVICE}-prod"
            SECRET_SUFFIX=""
            echo "üöÄ Deploying to PRODUCTION environment"
          else
            SERVICE_NAME="${SERVICE}-dev"
            SECRET_SUFFIX="_DEV"
            echo "üöÄ Deploying to DEVELOPMENT environment"
          fi

          echo "üì¶ Building and pushing $SERVICE to $IMAGE"
          timeout 1800 gcloud builds submit . \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE="$IMAGE",_SERVICE_NAME="$SERVICE" \
            --machine-type=e2-highcpu-8 \
            --disk-size=100

          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to build $SERVICE"
            exit 1
          fi

          echo "‚òÅÔ∏è Deploying $SERVICE_NAME to Cloud Run with secrets from Secret Manager"
          gcloud run deploy "$SERVICE_NAME" \
            --image "$IMAGE" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated \
            --quiet \
            --verbosity=info \
            --set-secrets=\
          SUPABASE_URL=SUPABASE_URL${SECRET_SUFFIX}:latest,\
          SUPABASE_AUTH_KEY=SUPABASE_AUTH_KEY${SECRET_SUFFIX}:latest,\
        
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to deploy $SERVICE_NAME"
            exit 1
          fi

          echo "‚úÖ Successfully deployed $SERVICE_NAME" 